package org.xxjr.busi.util.push.impl;

import java.util.HashMap;
import java.util.Map;

import org.ddq.common.security.md5.Md5;
import org.ddq.common.util.StringUtil;
import org.springframework.util.StringUtils;
import org.xxjr.busi.util.CountGradeUtil;
import org.xxjr.busi.util.borrow.IdCardResolveUtil;
import org.xxjr.busi.util.push.AbstractLoanUtil;
import org.xxjr.busi.util.push.PushCode;
import org.xxjr.busi.util.push.PushPlatformUtils;
import org.xxjr.sys.util.NumberUtil;
import org.xxjr.sys.util.SysParamsUtil;

import com.alibaba.fastjson.JSONObject;
@PushCode(33)
public class PushWfdUtil extends AbstractLoanUtil {

	@Override
	public Map<String, Object> response(Map<String, Object> row)
			throws Exception {
		Map<String, Object> response = new HashMap<String, Object>();
		int status = 2;
		Object message = null;
		
		String url = SysParamsUtil.getStringParamByKey("push_wfd_cfg_url", "https://loannew.xiangrongdai.com/api/collect-info");
		Map<String, Object> resMap = PushPlatformUtils.httpPost(url, null, getJson(row), true, null);
		if (NumberUtil.getInt(resMap.get("code"), -1) == 1) {
			status = 1;
		}
		message = resMap.get("message");
		response.put("status", status);
		response.put("message", message);
		return response;
	}

	private String getJson(Map<String, Object> row) {
		JSONObject content = new JSONObject();
		String key = SysParamsUtil.getStringParamByKey("push_wfd_cfg_key", "1f9765c556aa0054234e8569e266022b");
		String code = SysParamsUtil.getStringParamByKey("push_wfd_cfg_code", "jrxx180");
		String telephone = StringUtil.objectToStr(row.get("telephone"));
		String sign = Md5.getInstance().encrypt(code.concat("_").concat(telephone).concat("_").concat(key));
		content.put("code", code);
		content.put("sign", sign);
		String adid = SysParamsUtil.getStringParamByKey("push_wfd_cfg_adid", "xx001");
		String channelCode = StringUtil.objectToStr(row.get("channelCode")) + ",";
		String channels = SysParamsUtil.getStringParamByKey("sys_third_data_channel", "ceshigdt") + ",";
		if (channels.contains(channelCode)) {
			adid = SysParamsUtil.getStringParamByKey("push_wfd_cfg_adid2", "xx002");
		}
		content.put("adid", adid);
		content.put("mobile", telephone);
		content.put("name", row.get("applyName"));
		content.put("ip", row.get("applyIp"));
		content.put("agree_insurance", 0);
		
		double loanAmount = NumberUtil.getDouble(row.get("loanAmount"), 1);
		if (loanAmount < 1) {
			content.put("loan_price", 1);
		} else if (loanAmount >= 1 && loanAmount < 3) {
			content.put("loan_price", 2);
		} else if (loanAmount >= 3 && loanAmount < 5) {
			content.put("loan_price", 3);
		} else if (loanAmount >= 5 && loanAmount < 10) {
			content.put("loan_price", 4);
		} else {
			content.put("loan_price", 5);
		}
		content.put("loan_month", 4);
		int creditType = NumberUtil.getInt(row.get("creditType"), 2);
		if (creditType > 0 && creditType != 2) {
			if (creditType == 1) {
				content.put("loan_credit", 1);
			}else {
				content.put("loan_credit", 2);
			}
		}else {
			content.put("loan_credit", 3);
		}
		
		String cityName = StringUtil.getString(row.get("cityName"));
		if (cityName.endsWith("市")) {
			cityName = cityName.substring(0, cityName.indexOf('市'));
		}
		content.put("city_name", cityName);
		int carType = NumberUtil.getInt(row.get("carType"), 2);
		content.put("car", CountGradeUtil.judgeCar(carType) ? 1 : 0);
		
		int houseType = NumberUtil.getInt(row.get("houseType"), 2);
		content.put("house", CountGradeUtil.judgeHouse(houseType) ? 1 : 0);
		
		int insurType = NumberUtil.getInt(row.get("insurType"), 2);
		content.put("life_insurance", CountGradeUtil.judgeInsurType(insurType) ? 1 : 0);
		
		int fundType = NumberUtil.getInt(row.get("fundType"), 0);
		content.put("fund", CountGradeUtil.judgeFundType(fundType) ? 1 : 0);
		
		int socialType = NumberUtil.getInt(row.get("socialType"), 0);
		content.put("social_security", CountGradeUtil.judgeSocialType(socialType) ? 1 : 0);
		
		double havePinan = NumberUtil.getDouble(row.get("havePinan"), 0);
		content.put("loan_webank", havePinan > 0 ? 1 : 0);
		
		int workType = NumberUtil.getInt(row.get("workType"), 1);//1无固定职业 2企业主 3个体户 4上班族 
		if (2 == workType) {
			content.put("profession", 4);
		}else if (3 == workType) {
			content.put("profession", 2);
		}else if (4 == workType) {
			content.put("profession", 1);
		}else {
			content.put("profession", 5);
		}
		
		int wagesType = NumberUtil.getInt(row.get("wagesType"), 1);
		if (wagesType == 1) {
			content.put("salary_type", 1);
		}else {
			content.put("salary_type", 3);
		}
		
		double income = NumberUtil.getDouble(row.get("income"), 0);
		if (income > 5000 && income < 10000) {
			content.put("salary", 3);
		}else if (income > 10000) {
			content.put("salary", 4);
		}else {
			content.put("salary", 2);
		}
		
		String sex = StringUtil.getString(row.get("sex"));
		if (StringUtils.isEmpty(sex)) {
			sex = IdCardResolveUtil.getSex(StringUtil.getString("identifyNo")).toString();
		}
		if ("0".equals(sex)) {
			content.put("gender", "0");
		} else {
			content.put("gender", "1");
		}
		
		String identifyNo = StringUtil.getString(row.get("identifyNo"));
		String birthday = IdCardResolveUtil.getBirthday(identifyNo);
		int age = IdCardResolveUtil.getAge(identifyNo);
		if (age == -1) {
			age = NumberUtil.getInt(row.get("age"), -1);
		}
		content.put("birthday", PushPlatformUtils.getBirthDay(birthday, age));
		return content.toJSONString();
	}
	

}
