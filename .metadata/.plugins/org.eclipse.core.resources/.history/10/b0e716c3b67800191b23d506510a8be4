package org.xxjr.busi.util.push.impl;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.ddq.common.security.md5.Md5;
import org.ddq.common.util.DateUtil;
import org.ddq.common.util.StringUtil;
import org.springframework.util.StringUtils;
import org.xxjr.busi.util.borrow.IdCardResolveUtil;
import org.xxjr.busi.util.push.AbstractInsureUtil;
import org.xxjr.busi.util.push.PushCode;
import org.xxjr.busi.util.push.PushPlatformUtils;
import org.xxjr.sys.util.NumberUtil;
import org.xxjr.sys.util.SysParamsUtil;

import com.alibaba.fastjson.JSONObject;
@PushCode(29)
public class PushYunMuUtil extends AbstractInsureUtil{

	@SuppressWarnings("unchecked")
	@Override
	public Map<String, Object> response(Map<String, Object> row)
			throws Exception {
		int status = 2;
		Object message = null;
		Map<String, Object> response = new HashMap<String, Object>();
		try {
			if (PushPlatformUtils.isPushTest()) {
				row.remove("identifyNo");
				row.put("applyName", "张三");
				row.put("age", 27);
			}
			String url = SysParamsUtil.getStringParamByKey("push_yunmu_cfg_url", "https://api.yunmicloud.xin/v1/insurance/free/get-rand-insurance");
			Map<String, Object> resMap = PushPlatformUtils.httpPost(url, null, paramToBody(row), true, null);
			Map<String, Object> state = (Map<String, Object>) resMap.get("state");
			if (state == null || state.isEmpty()) {
				message = "返回state为空";
				return response;
			}
			if (0 == NumberUtil.getInt(state.get("code"), -1)) {
				status = 1;
			}
			message = state.get("msg");
		} catch (Exception e) {
			throw e;
		}finally{
			response.put("status", status);
			response.put("message", message);
		}
		return response;
	}
	
	
	private String paramToBody(Map<String, Object> row){
		JSONObject content = new JSONObject();
		String id = getUUid();
		String appId = SysParamsUtil.getStringParamByKey("push_yunmu_cfg_appId", "f8d4d59b2b574bce9a8368a60f67af6c");
		String appkey = SysParamsUtil.getStringParamByKey("push_yunmu_cfg_appkey", "86237fbd434843dcb11aa1a76ab7a977");
		String timestamp = DateUtil.toStringByParttern(new Date(), DateUtil.DATE_PATTERNYYYYMMDDHHMMSSSSS);
		String sign = Md5.getInstance().encrypt((id.concat(":").concat(appId).concat(":").concat(appkey).concat(":").concat(timestamp)));
		content.put("id", id);
		content.put("appId", appId);
		content.put("timestamp", timestamp);
		content.put("encrypt", "md5");
		content.put("sign", sign);
		
		JSONObject data = new JSONObject();
		data.put("userIp", row.get("applyIp"));
		
		JSONObject applicant = new JSONObject();
		applicant.put("name", row.get("applyName"));
		
		String identifyNo = StringUtil.objectToStr(row.get("identifyNo"));
		if (!StringUtils.isEmpty(identifyNo)) {
			applicant.put("certiType", "ID_CARD");
			applicant.put("certiNo", identifyNo);
			String birthDay = IdCardResolveUtil.getBirthday(identifyNo);
			applicant.put("birthDay", birthDay);
			applicant.put("gender", (IdCardResolveUtil.getSex(identifyNo) == 1 ? "MALE" : "FEMALE"));
		}else {
			int age = NumberUtil.getInt(row.get("age"), 28);
			String birthDay = PushPlatformUtils.getBirthDay(IdCardResolveUtil.getBirthday(identifyNo), age);
			applicant.put("birthDay", birthDay);
			int sex = NumberUtil.getInt(row.get("sex"), 1);
			applicant.put("gender", (sex == 1 ? "MALE" : "FEMALE"));
		}
		
		String src = SysParamsUtil.getStringParamByKey("push_yunmu_cfg_src", "xiaoxiaojinrong1;xiaoxiaojinrong2");
		int sourceType = NumberUtil.getInt(row.get("sourceType"), 0);
		String[] srcArray = src.split(";");
		applicant.put("src", srcArray[sourceType]);
		applicant.put("mobile", row.get("telephone"));
		applicant.put("agreed", "YES");
		data.put("applicant", applicant);
		content.put("data", data);
		return content.toJSONString();
	}

	
	public static String getUUid () {
		String uuid = StringUtil.getUUID();
		uuid = uuid.replaceAll("-", "");
		return uuid;
	}
}
