package org.xxjr.job.listener.crm;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.ddq.active.mq.message.JpushMessageSend;
import org.ddq.common.constant.DuoduoConstant;
import org.ddq.common.context.AppParam;
import org.ddq.common.context.AppProperties;
import org.ddq.common.context.AppResult;
import org.ddq.common.core.SpringAppContext;
import org.ddq.common.util.DateUtil;
import org.ddq.common.util.LogerUtil;
import org.ddq.job.core.BaseExecteJob;
import org.ddq.job.util.JobConstant;
import org.ddq.job.util.JobUtil;
import org.ddq.common.core.service.RemoteInvoke;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;
import org.xxjr.sys.util.ServiceKey;
import org.xxjr.sys.util.message.MessageConstants;



/***
 * 还款提醒
 * @author qinxcb
 *
 */
@Lazy
@Component
public class AutoRemindRepayJob implements BaseExecteJob {
	
	@Override
	public AppResult executeJob(AppParam param) {
		Object processId = param.getAttr(JobConstant.KEY_processId);
		AppResult result = new AppResult();
		int total = 0;
		// 当前时间
		String curTime = DateUtil.toStringByParttern(new Date(), DateUtil.DATE_PATTERN_YYYY_MM_DD_HHMM);
		curTime = curTime + ":00";
		int curPage = 1;
		// 查询符合当前时间的还款计划记录
		AppParam queryParam = new AppParam();
		queryParam.setService("daiRepayPlanService");
		queryParam.setMethod("queryRemindByPage");
		queryParam.addAttr("repayStatus", "0");
		queryParam.addAttr("addType", "2");
		queryParam.addAttr("curTime", curTime);
		queryParam.setCurrentPage(curPage);
		queryParam.setEveryPage(50);
		queryParam.setOrderBy("t.createTime");
		queryParam.setOrderValue("desc");
		queryParam.setRmiServiceName(AppProperties
				.getProperties(DuoduoConstant.RMI_SERVICE_START
						+ ServiceKey.Key_crmsys));
		AppResult queryResult = RemoteInvoke.getInstance().callNoTx(queryParam);
		JpushMessageSend jpushSend = (JpushMessageSend) SpringAppContext.getBean(JpushMessageSend.class);
		while(queryResult.getRows().size() > 0){
			for(Map<String,Object> row : queryResult.getRows()){
				// 封装极光推送消息类型
				String customerId = row.get("custId").toString();
				Map<String, Object> msgParam = new HashMap<String, Object>();
				msgParam.put("loanOrg", row.get("loanOrg"));
				msgParam.put("repayAmount", row.get("repayAmount"));
				msgParam.put("realName", row.get("name"));
				msgParam.put("jpushType", MessageConstants.jpush_Type_1);
				msgParam.put("jpushClientType", "xdjl");//推送给信贷经理app
				
				jpushSend.sendCustMessage(customerId, "repayRemind", msgParam);
			}
			total += queryResult.getRows().size();
			curPage += 1;
			queryParam.setCurrentPage(curPage);
			queryParam.setRmiServiceName(AppProperties.
					getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_crmsys));
			queryResult = RemoteInvoke.getInstance().callNoTx(queryParam);
		}
		LogerUtil.debug("AutoRemindRepayJob over");
		JobUtil.addProcessExecute(processId, "还款提醒已处理，一共通知了：" + total + "位客户");
		result.setMessage("还款提醒已处理，一共通知了：" + total + "位客户");
		
		return result;
	}
	
}
