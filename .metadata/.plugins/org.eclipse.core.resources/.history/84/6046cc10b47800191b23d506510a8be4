package org.xxjr.cust.util.fund;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.ddq.common.constant.DuoduoConstant;
import org.ddq.common.context.AppParam;
import org.ddq.common.context.AppProperties;
import org.ddq.common.context.AppResult;
import org.ddq.common.core.SpringAppContext;
import org.ddq.common.core.service.SoaManager;
import org.ddq.model.cache.RedisUtils;
import org.ddq.zk.service.RemoteInvoke;
import org.springframework.util.StringUtils;
import org.xxjr.cust.util.FundConstant;
import org.xxjr.cust.util.info.CustomerUtil;
import org.xxjr.sys.util.NumberUtil;
import org.xxjr.sys.util.ServiceKey;
import org.xxjr.sys.util.SysParamsUtil;

public class MjbCustAmountUtil {

	/**已经认证的身分信息**/
	public static String CacheKey_PASS = "Mjb_custAmount";
	/**获取充值配置的key**/
	public static String KEY_RECHARGE_CONFIG = "mjb_key_recharge_config";
	
	/***
	 * 获取充值配置
	 * @return
	 */
	@SuppressWarnings("unchecked")
	public static List<Map<String, Object>> getRechargeConfig(){
		List<Map<String, Object>> list = (List<Map<String, Object>>) RedisUtils.getRedisService().get(KEY_RECHARGE_CONFIG);
		if(list == null){
			list = refershRechargeConfig();
		}
		return list;
	}
	
	public static List<Map<String, Object>> refershRechargeConfig(){
		 AppParam params = new AppParam();
		 params.setService("rechargeConfigService");
		 params.setMethod("query");
		 params.setOrderBy("configId");
		 params.setOrderValue("desc");
		 params.addAttr("isEnable", "1");
		 AppResult result=ServiceKey.doCallNoTx(params, ServiceKey.Key_mjb);
		 List<Map<String, Object>> list = new ArrayList<Map<String,Object>>();
		 if(result.getRows().size()>0){
			 list = result.getRows();
			 RedisUtils.getRedisService().set(KEY_RECHARGE_CONFIG, (Serializable)list);
		 }
		 return list;
	}
	
	/***
	 * 获取用户 可用金额 
	 * @return
	 */
	@SuppressWarnings("unchecked")
	public static Map<String,Object> getCustAmount(String customerId){
		Map<String, Object> userMap = ((Map<String, Object>) RedisUtils.getRedisService().get(CacheKey_PASS + customerId));
		if(userMap == null){
			userMap = refershAmount(customerId);
		}
		return userMap;
	}
	
	
	/***
	 * 获取用户 可用金额 
	 * @return
	 */
	public static Map<String,Object> refershAmount(String customerId){
		AppParam param = new AppParam();
		param.setService("custAmountService");
		param.setMethod("query");
		param.addAttr("customerId", customerId);
		AppResult result = ServiceKey.doCall(param, ServiceKey.Key_mjb);
		if(result.getRows().size()==0){
			return new HashMap<String,Object>();
		}
		Map<String, Object> userMap = result.getRow(0);
		RedisUtils.getRedisService().set(CacheKey_PASS + customerId, (Serializable)userMap, CustomerUtil.CACHE_TIME);
		return userMap;
	}
	/**
	 * 资金变动
	 * @param params
	 */
	public static AppResult updateAmount(AppParam params){
		AppParam amountParam = new AppParam();
		amountParam.addAttrs(params.getAttr());
		amountParam.setService("custAmountService");
		amountParam.setMethod("updateCustAmount");
		return ServiceKey.doCall(amountParam, ServiceKey.Key_mjb);
	}
	
	/**
	 * 可抢优质单资金变动
	 * @param params
	 */
	public static AppResult updateSeniorAmount(AppParam params){
		AppParam amountParam = new AppParam();
		amountParam.addAttrs(params.getAttr());
		amountParam.setService("custAmountService");
		amountParam.setMethod("updateSeniorAmount");
		return ServiceKey.doCall(amountParam, ServiceKey.Key_mjb);
	}
	
	/**
	 * 查询已赠送金额
	 * @param params
	 */
	public static Map<String,Object> querySeniorAmount(String customerId){
		AppResult result = new AppResult();
		AppParam amountParam = new AppParam();
		amountParam.addAttr("customerId", customerId);
		amountParam.setService("custAmountService");
		amountParam.setMethod("querySeniorAmount");
		result = ServiceKey.doCallNoTx(amountParam, ServiceKey.Key_mjb);
		
		return result.getRows().size() > 0 ? result.getRow(0) : result.getAttr();
	}
	
	/**
	 * 优质单回款确认 
	 * @param params
	 * @return
	 */
	public static AppResult seniorRepayCheck(AppParam params){
		AppResult result = new AppResult();
		String customerId = params.getAttr("customerId").toString();
		String recordId = params.getAttr("recordId").toString();
		double feeAmount = NumberUtil.getDouble(params.getAttr("feeAmount"));
		
		// 还钱
		AppParam amtParams = new AppParam();
		amtParams.addAttr("customerId", customerId);
		amtParams.addAttr("amount", 0);
		amtParams.addAttr("leftRepayAmount", -feeAmount);
		amtParams.addAttr("fundType", FundConstant.FundType_Senior_Reward);
		amtParams.addAttr("orderId", recordId);
		amtParams.addAttr("recordDesc", "抢优质单提成还款");
		result = updateSeniorAmount(amtParams);
		
		return result;
	}
	
	/**
	 * 修改用户折扣
	 */
	public static AppResult updateUserDiscount(String customerId){
		AppParam params = new AppParam("custAmountService","updateUserDiscount");
		params.addAttr("customerId", customerId);
		return ServiceKey.doCall(params, ServiceKey.Key_mjb);
	}
	
	/**
	 * 更新可抢优质单或剩餘待還金額及提成金额
	 * @param params
	 * @return
	 */
	public static AppResult updateRewardAmount(Object customerId, Object recordId, 
			Object rewardVal,Object leftRepayAmount){
		AppParam amtParams = new AppParam();
		amtParams.addAttr("customerId", customerId);
		amtParams.addAttr("amount", rewardVal);
		amtParams.addAttr("recordDesc", "抢优质单提成");
		if(!StringUtils.isEmpty(leftRepayAmount)){
			amtParams.addAttr("leftRepayAmount", leftRepayAmount);
			amtParams.addAttr("recordDesc", "抢优质单提成还款");
		}
		amtParams.addAttr("fundType", FundConstant.FundType_Senior_Reward);
		amtParams.addAttr("orderId", recordId);
		AppResult amountResult = updateSeniorAmount(amtParams);
		
		// 记录回款提成
		if(amountResult.isSuccess()){
			AppParam treatParam = new AppParam();
			treatParam.setService("treatSuccessService");
			treatParam.setMethod("update");
			treatParam.addAttr("rewardAmount", rewardVal);
			treatParam.addAttr("recordId", recordId);
			treatParam.addAttr("customerId", customerId);
			treatParam.setRmiServiceName(AppProperties
					.getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_busi_in));
			if (SpringAppContext.getBean("treatSuccessService") == null) {
				RemoteInvoke.getInstance().call(treatParam);
			}else{
				SoaManager.getInstance().invoke(treatParam);
			}
		}
		return new AppResult();
	}
	/**
	 * 查询用户未使用的赠送金额
	 * @param customerId
	 * @param usableAmount
	 * @return
	 */
	public static double getUnusedAmount(String customerId, Object usableAmount) {
		double differ = 0;// 还未用完的赠送金额
		AppParam param = new AppParam();
		param.setService("rechargeService");
		param.setMethod("queryRechargeRecords");
		param.addAttr("startDate", SysParamsUtil.getStringParamByKey("rechargeActivityDate", "2018-02-28"));
		param.addAttr("customerId", customerId);
		AppResult result = ServiceKey.doCallNoTx(param, ServiceKey.Key_mjb);
		List<Map<String,Object>> records = result.getRows();
		double custUsableAmount = NumberUtil.getDouble(usableAmount, 0);
		if (records.size() == 0 && custUsableAmount > 0) {
			differ = custUsableAmount;
		}else{
			Map<String,Object> rechargeSummary = records.get(0);
			double totalAmount = NumberUtil.getDouble(rechargeSummary.get("totalAmount"), 0);
			if(totalAmount <= 0){
				differ = custUsableAmount;
			}else{
				if(custUsableAmount > totalAmount){
					differ = custUsableAmount - totalAmount;
				}
			}
		}
		return differ;
	}
}
