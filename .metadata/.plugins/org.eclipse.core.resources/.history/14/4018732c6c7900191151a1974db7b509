package org.xxjr.job.listener.wx;

import java.util.Map;

import org.ddq.common.constant.DuoduoConstant;
import org.ddq.common.context.AppParam;
import org.ddq.common.context.AppProperties;
import org.ddq.common.context.AppResult;
import org.ddq.common.util.LogerUtil;
import org.llw.ddq.job.core.BaseExecteJob;
import org.llw.ddq.job.util.JobConstant;
import org.llw.ddq.job.util.JobUtil;
import org.ddq.common.core.service.RemoteInvoke;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;
import org.xxjr.sys.util.ServiceKey;

/**
 * 清除过期海报二维码ticket
 * @author Administrator
 *
 */
@Lazy
@Component
public class CleanTicketJob implements BaseExecteJob {

	@Override
	public AppResult executeJob(AppParam param) {
		AppResult result = new AppResult();
		Object processId = param.getAttr(JobConstant.KEY_processId);
		
		LogerUtil.debug("start CleanTicketJob");
		// 公众号信息
		AppParam gzhParam = new AppParam();
		gzhParam.setService("gzhInfoService");
		gzhParam.setMethod("query");
		gzhParam.addAttr("type", "1");
		gzhParam.addAttr("enable", "1");
		gzhParam.setRmiServiceName(AppProperties.
				getProperties(DuoduoConstant.RMI_SERVICE_START+ServiceKey.Key_wx));
		AppResult gzhResult =RemoteInvoke.getInstance().call(gzhParam);;
		
		int overdueDay = 35;
		for(Map<String,Object> gzhInfo : gzhResult.getRows()){
			// 统计海报
			Object gzhId = gzhInfo.get("gzhId");
			AppParam deleteParam = new AppParam();
			deleteParam.addAttr("overdueDay", overdueDay);
			deleteParam.addAttr("gzhId", gzhId);
			deleteParam.setService("custTicketService");
			deleteParam.setMethod("deleteOverdue");
			deleteParam.setRmiServiceName(AppProperties.
					getProperties(DuoduoConstant.RMI_SERVICE_START+ServiceKey.Key_wx));
			try {
				RemoteInvoke.getInstance().call(deleteParam);
			} catch (Exception e) {
				LogerUtil.error(CleanTicketJob.class, e, "cleanOverdue error");
				result.setMessage(e.getMessage());
			}
		}
		LogerUtil.debug("CleanTicketJob over");
		JobUtil.addProcessExecute(processId, "清除过期二维码ticket成功");
		return result;
	}
}
