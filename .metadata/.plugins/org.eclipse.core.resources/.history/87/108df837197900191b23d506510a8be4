package org.xxjr.busi.utils;

import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.ddq.active.mq.message.RmiServiceSend;
import org.ddq.common.constant.DuoduoConstant;
import org.ddq.common.context.AppParam;
import org.ddq.common.context.AppProperties;
import org.ddq.common.context.AppResult;
import org.ddq.common.core.SpringAppContext;
import org.ddq.common.core.service.RemoteInvoke;
import org.ddq.common.core.service.SoaManager;
import org.ddq.common.util.DateUtil;
import org.ddq.common.util.StringUtil;
import org.springframework.util.StringUtils;
import org.xxjr.busi.util.ApplyAllotUtil;
import org.xxjr.busi.util.ApplyUnionUtil;
import org.xxjr.busi.util.BorrowChannelUtil;
import org.xxjr.busi.util.StoreSeparateUtils;
import org.xxjr.busi.util.push.PushPlatformUtils;
import org.xxjr.cust.util.CustConstant;
import org.xxjr.cust.util.info.CustomerUtil;
import org.xxjr.sys.util.NumberUtil;
import org.xxjr.sys.util.ServiceKey;
import org.xxjr.sys.util.SysParamsUtil;
import org.xxjr.sys.util.active.ActiveUtil;

import lombok.extern.slf4j.Slf4j;

/**
 * 分单成本工具类
 * @author zenghw
 *
 */
@Slf4j
public class AllotCostUtil {
	
	/**
	 * 判断是否满足记录分单成本条件
	 * @param applyTime
	 * @return
	 */
	public static boolean isAllotCost(String applyTime){
		Date nowTime = DateUtil.toDateByString(applyTime, DateUtil.DATE_PATTERN_YYYY_MM_DD_HHMMSS);
		Calendar cal = Calendar.getInstance();
		cal.setTime(new Date());
		//1周日 2周一 3周二......
		int w = cal.get(Calendar.DAY_OF_WEEK);
		if(2 == w){
			//当前时间前两天
			String afterTowDay = DateUtil.toStringByParttern(getNextDay(new Date(),-2), DateUtil.DATE_PATTERN_YYYY_MM_DD)+ " 00:00:00";
			Date beforDate = DateUtil.toDateByString(afterTowDay, DateUtil.DATE_PATTERN_YYYY_MM_DD_HHMMSS);
			//判断applyTime是否在时间段内
			boolean belong = belongCalendar(nowTime,beforDate,new Date());
			if(belong){
				return true;
			}
		}else{
			//当前时间前一天
			String beforOneDay = DateUtil.toStringByParttern(getNextDay(new Date(),-1), DateUtil.DATE_PATTERN_YYYY_MM_DD)+ " 00:00:00";
			Date beforDate = DateUtil.toDateByString(beforOneDay, DateUtil.DATE_PATTERN_YYYY_MM_DD_HHMMSS);
			boolean belong2 = belongCalendar(nowTime,beforDate,new Date());
			if(belong2){
				return true;
			}
		}
		return false;
	}
	
	/**
	 * 获取当前系统前几天日期
	 * @param date
	 * @return
	 */
	public static Date getNextDay(Date date,int beforeDay) {  
        Calendar calendar = Calendar.getInstance();  
        calendar.setTime(date);  
        calendar.add(Calendar.DAY_OF_MONTH, beforeDay);  
        date = calendar.getTime();  
        return date;  
    }  
	
	
	/**
     * 判断时间是否在时间段内
     * @param nowTime
     * @param beginTime
     * @param endTime
     * @return
     */
    public static boolean belongCalendar(Date nowTime, Date beginTime, Date endTime) {
        if (nowTime.getTime() > beginTime.getTime()  && nowTime.getTime() < endTime.getTime()) {
            return true;
        } else {
            return false;
        }
    }
    
	/**
	 * 通过MQ同步t_apply_union 信息,传所有参数
	 * @param paramsMap
	 */
	public static  void updateUnionInfoByMQ(Object applyId, Object customerId, Object statusType,Object status){
		try {
			Map<String, Object> paramsMap = new HashMap<String, Object>();
			if (StringUtils.isEmpty(customerId)) {
				paramsMap.put("clearDealCustInfo", 1);
			}else {
				AppParam custParam = new AppParam();
				custParam.addAttr("customerId", customerId);
				Map<String, Object> queryCustInfo = CustomerUtil.queryCustInfo(custParam);
				paramsMap.put("dealCustId", queryCustInfo.get("customerId"));
				paramsMap.put("dealName", queryCustInfo.get("userName"));
				paramsMap.put("dealTelephone", queryCustInfo.get("telephone"));
			}
			paramsMap.put("statusType", statusType);
			paramsMap.put("status", status);
			paramsMap.put("applyId", applyId);
			Map<String, Object> queryApplyInfo = ApplyUnionUtil.queryApplyInfo(applyId, null);
			paramsMap.put("unionId", queryApplyInfo.get("unionId"));
			updateUnionInfoByMQ(paramsMap);
		} catch (Exception e) {
			log.error("updateUnionInfoByMQ error", e);
		}
	}
	
	/**
	 * 通过MQ同步t_apply_union 信息
	 * @param paramsMap
	 */
	public static  void updateUnionInfoByMQ(Map<String,Object> paramsMap){
		try{
			paramsMap.put("service", "applyUnionService");
			paramsMap.put("method", "unionUpdate");
			paramsMap.put("rmiServiceName", AppProperties
					.getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_busi));
			
			RmiServiceSend messageSend = SpringAppContext.getBean(RmiServiceSend.class);
			messageSend.sendExecuteMessage(paramsMap);
		}catch(Exception e){
			log.error("更新t_apply_union 失败，unionId=" +StringUtil.getString(paramsMap.get("unionId")), e);
		}
	}
	
	/**
	 * 通过MQ同步注册数
	 * @param paramsMap
	 */
	public static void pageCount (AppParam param) {
		Map<String, Object> paramsMap = new HashMap<String, Object>();
		try {
			paramsMap.put("service", "pageCountService");
			paramsMap.put("method", "recordCount");
			paramsMap.put("rmiServiceName", AppProperties
					.getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_sum));
			Object pageId = param.getAttr("pageId");
			Object pageReferer = param.getAttr("pageReferer");
			if (StringUtils.isEmpty(pageReferer)) {
				pageReferer = param.getAttr("sysCode");
			}
			if (StringUtils.isEmpty(pageId) && StringUtils.isEmpty(pageReferer)) {
				return;
			}
			if (StringUtils.isEmpty(param.getAttr("sumType"))) {//如果sumType不传，就默认统计pv
				param.addAttr("sumType", "pv");
			}
			
			Object channelDetail = param.getAttr("regSourceType");
			if (StringUtils.isEmpty(channelDetail)) {
				channelDetail = param.getAttr("channelDetail");
			}
			channelDetail = StringUtils.isEmpty(channelDetail) ? CustConstant.CUST_SOURCETYPE_DEFAULT
					: channelDetail;
			paramsMap.put("pageId", pageId);
			paramsMap.put("sumType", param.getAttr("sumType"));
			paramsMap.put("pageReferer", pageReferer);
			String channelCode = BorrowChannelUtil.getChannelByStartCode(channelDetail.toString());
			paramsMap.put("channelCode", channelCode);
			paramsMap.put("channelDetail", channelDetail);
			RmiServiceSend send = SpringAppContext.getBean(RmiServiceSend.class);
			send.sendExecuteMessage(paramsMap);
		} catch (Exception e) {
			log.error("同步注册数 失败", e);
		}
	}
	
	
	/**
	 * 通过MQ同步t_apply_union 信息
	 * @param paramsMap
	 */
	public static  AppResult immedTranApply(Map<String,Object> now){
		AppResult result = new AppResult();
		try{
			String applyName = StringUtil.getString(now.get("applyName"));
			if(applyName.indexOf("测试")> -1){
				return result;
			}
			
			ApplyAllotUtil.conversionType(now);
			
			AppParam gradeParam = new AppParam();
			gradeParam.addAttrs(now);
			AppResult gradeResult = ActiveUtil.getGrade(gradeParam);//获取等级
			
			String grade = StringUtil.getString(gradeResult.getAttr("rewardValue")) ;
			if (StringUtils.isEmpty(grade)) {
				grade = "F";
			}
			
			int insure = NumberUtil.getInt(now.get("insure"),0);//是否勾选保险协议
			String cityName = StringUtil.getString(now.get("cityName"));
			
			double loanAmount = NumberUtil.getDouble(now.get("loanAmount"), 0);
			
			int allotFlag = 0;
			String testDatachannels = SysParamsUtil.getStringParamByKey("test_data_channel", "cccj,ccdx,aijjk,soho") + ",";
			String netChannelCodes = SysParamsUtil.getStringParamByKey("netChannelCodes", "");
			String saleChannelCodes = SysParamsUtil.getStringParamByKey("saleChannelCodes", "");
			String kfChannelCodes = SysParamsUtil.getStringParamByKey("kfChannelCodes", "");
			String channelCode = StringUtil.getString(now.get("channelCode"));

			if(StringUtils.hasText(netChannelCodes) 
					&& StringUtils.hasText(channelCode) 
					&& (netChannelCodes.indexOf(channelCode+",") >-1 || testDatachannels.indexOf(channelCode+",") >-1)){
				boolean flag = SysParamsUtil.getBoleanByKey("open_kf_test_channel", false);
				String cityNames = SysParamsUtil.getStringParamByKey("kf_test_channel_citys", "深圳市");
				String notChannels = SysParamsUtil.getStringParamByKey("kf_test_not_channel", "keji001");
				if (flag && cityNames.contains(cityName) && (!notChannels.contains(channelCode))) {
					allotFlag = 4;
				}else {
					allotFlag = 1;
					now.put("testNetChannel", 1);
				}
			} else if(StringUtils.hasText(saleChannelCodes) 
					&& StringUtils.hasText(channelCode) 
					&& saleChannelCodes.indexOf(channelCode+",") >-1){
				allotFlag = 2;
			}else if(StringUtils.hasText(kfChannelCodes) 
					&& StringUtils.hasText(channelCode) 
					&& kfChannelCodes.indexOf(channelCode+",") >-1){
				
				allotFlag = 4;
			}else{
				allotFlag = ApplyAllotUtil.allot(grade, cityName,insure,loanAmount);//分单
			}
			
			now.put("grade", grade);//客户等级
			//分网销的并且表示测试渠道并且没有分小贷过的
			if (PushPlatformUtils.isAllotThird(now) && NumberUtil.getInt(now.get("testNetChannel"), 0) == 0) {
				allotFlag = 8;
			}
			
			
			//同步用户授权信息
			String channelDetail = StringUtil.objectToStr(now.get("channelDetail"));
			String authChannel = "appAuth";
			Object customerId = now.get("customerId");
			
			now.put("insure", insure);//保险标志			
			now.put("allotFlag", allotFlag);//分单标识
			
			if (authChannel.equals(channelDetail)&& allotFlag == 2) {
				//如果渠道号为appAuth并且为转挂卖，就去同步t_dai_borrow_auth_info,这里转挂卖时需要用到授权信息去计算价格所以要在转之前执行
				syncDaiAuthInfo(customerId);
			}
			
			String tgChannel = SysParamsUtil.getStringParamByKey("apply_sendTgbi", "tgw");
			if (tgChannel.equals(now.get("channelDetail")) && NumberUtil.getInt(now.get("status"), 1) == 0) {
				AllotCostUtil.sendTgCurrency(1, now.get("telephone"), null);
			}
			
			result = ApplyAllotUtil.saveBorrowApplyInfo(now, allotFlag);
			
			if (authChannel.equals(channelDetail)){//如果渠道号为appAuth就同步,applyId只有转了以后才会有
				updateAuthInfo(customerId, result.getAttr("applyId"));
			}
			
			//mq的方式保存推荐记录
			saveRefererLoan(now, result.getAttr("applyId"), allotFlag);
		}catch(Exception e){
			result.setSuccess(false);
			StackTraceElement[] stackTrace = e.getStackTrace();
			if (stackTrace.length > 0) {
				String errorNumber = stackTrace[0].toString();
				result.setMessage(e.getMessage() + "|" + errorNumber);//记录一下是第几行报错
			}
			log.error("立即分单失败，参数：" +now, e);
		}
		return result ;
	}
	
	/**
	 * 计算分单成本公共方法
	 * @param param
	 */
	public static void computeAllotOrderCost(AppParam param){
		//String applyTime = StringUtil.getString(param.getAttr("applyTime"));
		String customerId = StringUtil.getString(param.getAttr("customerId"));
		String applyId = StringUtil.getString(param.getAttr("applyId"));
		//是否满足记录分单成本
//		boolean isCost = AllotCostUtil.isAllotCost(applyTime);
		boolean isCost = true;
		//保存记录到门店人员分单成本统计
		if(isCost){
			AppParam costParams = new AppParam("storeCostRecordService","insert");
			costParams.addAttr("customerId", customerId);
			costParams.addAttr("applyId", applyId);
			costParams.addAttr("orgId", param.getAttr("orgId"));
			costParams.addAttr("recordDate", DateUtil.getSimpleFmt(new Date()));
			Map<String,Object> baseMap = StoreSeparateUtils.getBaseConfig();//获取全局配置
			if(baseMap != null){
				costParams.addAttr("price", baseMap.get("allotPrice"));//分单成本
			}
			SoaManager.getInstance().invoke(costParams);
		}
	}
	
	/**
	 * 同步t_borrow_auth_info表的borrowApplyId
	 * 分单过程中用不到，可以去使用mq执行
	 * @param applyId
	 * @param borrowApplyId
	 */
	public static void updateAuthInfo (Object customerId, Object applyId) {
		try {
			if (StringUtils.isEmpty(customerId) || StringUtils.isEmpty(applyId)) {
				return;
			}
			Map<String, Object> param = new HashMap<String, Object>();
			param.put("service", "borrowAuthInfoService");
			param.put("method", "update");
			param.put("rmiServiceName", AppProperties.getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_busi_in));
			param.put("customerId", customerId);
			param.put("applyId", applyId);
			RmiServiceSend send = SpringAppContext.getBean(RmiServiceSend.class);
			send.sendExecuteMessage(param);
		} catch (Exception e) {
			log.error("同步t_borrow_auth_info的applyId失败!", e);
		}
	}
	
	/**
	 * 同步t_cust_auth_info
	 * 转挂卖计算价格时会用到直接远程调用
	 * @param applyId
	 * @param borrowId
	 */
	public static void syncDaiAuthInfo (Object customerId) {
		try {
			if (StringUtils.isEmpty(customerId)) {
				return;
			}
			AppParam queryParam = new AppParam("borrowAuthInfoService", "query");
			queryParam.addAttr("customerId", customerId);
			AppResult queryResult = SoaManager.getInstance().callNoTx(queryParam);
			if (queryResult.getRows().size() == 0) {
				return;
			}
			AppParam param = new AppParam("custAuthInfoService", "save");
			param.setRmiServiceName(AppProperties.getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_busi));
			param.addAttrs(queryResult.getRow(0));
			RemoteInvoke.getInstance().call(param);
		} catch (Exception e) {
			log.error("同步t_cust_auth_info表失败!", e);
		}
	}

	public static void saveRefererLoan (Map<String, Object> now,Object applyId, int allotFlag) {
		try {
			String referChannel = "referBorrow";
			if (!referChannel.equals(now.get("channelDetail")) || StringUtils.isEmpty(now.get("referer")) || StringUtils.isEmpty(now.get("applyId"))) {
				return;
			}
			int referStatus = (allotFlag == 1) ? 1 : 0; //代表复核门店要求代表推荐成功，是其他代考推荐失败
			AppParam param = new AppParam("daiReferRecordService", "save");
			param.addAttr("customerId", now.get("referer"));
			param.addAttr("applyName", now.get("applyName"));
			param.addAttr("telephone", now.get("telephone"));
			param.addAttr("applyId", applyId);
			param.addAttr("applyTime", now.get("applyTime"));
			param.addAttr("referStatus", referStatus);
			param.addAttr("allotFlag", allotFlag);
			SoaManager.getInstance().invoke(param);
		} catch (Exception e) {
			log.error("保存推荐记录失败!", e);
		}
	}
	
	public static void sendTgCurrency(int loanType, Object telephone, Object applyId){
		try {
			
			if (loanType == 2) {//回款时的判断
				AppParam queryParam = new AppParam("borrowApplyService", "query");
				queryParam.addAttr("applyId", applyId);
				AppResult result = SoaManager.getInstance().callNoTx(queryParam);
				if (result.getRows().size() == 1) {
					String tgChannel = SysParamsUtil.getStringParamByKey("apply_sendTgbi", "tgw");
					if (tgChannel.equals(result.getRow(0).get("channelDetail"))) {
						telephone = result.getRow(0).get("telephone");
					}
				}
			}
			
			if (StringUtils.isEmpty(telephone)) {
				return;
			}
			
			Map<String, Object> param = new HashMap<String, Object>();
			param.put("service", "xjRecAbilityRecordService");
			param.put("method", "sendLoanRewAbility");
			param.put("rmiServiceName", AppProperties.getProperties(DuoduoConstant.RMI_SERVICE_START + ServiceKey.Key_XJ));
			param.put("loanType", loanType);
			param.put("telephone", telephone);
			RmiServiceSend send = SpringAppContext.getBean(RmiServiceSend.class);
			send.sendExecuteMessage(param);
		} catch (Exception e) {
			log.error("送天狗币失败!", e);
		}
	}
}
